
# referee è£åˆ¤è¿›ç¨‹

<br>


## åŠŸèƒ½æ¦‚è¿°
è£åˆ¤è¿›ç¨‹æ˜¯æ•´ä¸ªæ¸¸æˆçš„æ§åˆ¶ä¸­å¿ƒï¼Œè´Ÿè´£ï¼š
1. **åˆ›å»ºå’Œç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—**
   - åˆå§‹åŒ–IPCé€šä¿¡è®¾æ–½
   - æ¸…ç†æ¶ˆæ¯é˜Ÿåˆ—èµ„æº

2. **åè°ƒæ¸¸æˆå›åˆ**
   - æŒ‰é¡ºåºé€šçŸ¥ç©å®¶å‡ºæ‹³
   - ç­‰å¾…ç©å®¶å›å¤ï¼ˆå¸¦è¶…æ—¶æœºåˆ¶ï¼‰
   - æ ¹æ®æ¸¸æˆè§„åˆ™åˆ¤æ–­èƒœè´Ÿ

3. **æ¸¸æˆçŠ¶æ€ç®¡ç†**
   - è®°å½•æ¯å›åˆå‡ºæ‹³é€‰æ‹©
   - ç»Ÿè®¡èƒœè´Ÿå’Œå¹³å±€æ¬¡æ•°
   - ç›‘æ§ç©å®¶è¶…æ—¶æƒ…å†µ

4. **è¾“å‡ºæ¸¸æˆç»“æœ**
   - å®æ—¶æ˜¾ç¤ºæ¯å›åˆæˆ˜å†µ
   - è¾“å‡ºæœ€ç»ˆèƒœè´Ÿç»Ÿè®¡


<br>

## ğŸ¯ å®é™…ä»£ç æµç¨‹ï¼š
```
â†’ åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ— 
â†’ å¾ªç¯Nå›åˆ 
    â†’ æ¯å›åˆï¼šç©å®¶1å‡ºæ‹³ â†’ ç©å®¶2å‡ºæ‹³ â†’ åˆ¤æ–­èƒœè´Ÿ â†’ ç»Ÿè®¡ 
â†’ æœ€ç»ˆæŠ¥å‘Š
```

<br>

## è¯¦ç»†è®¾è®¡
#### 1. åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
- ä½¿ç”¨ `ftok(".", 'R')` åŸºäºå½“å‰ç›®å½•ç”Ÿæˆå”¯ä¸€key
- é€šè¿‡ `msgget()` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
- **å¼ºåˆ¶åˆ›å»ºç­–ç•¥**ï¼šå¦‚æœkeyå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤å†åˆ›å»º
- **å®‰å…¨æ€§**ï¼šä¸ªäººè™šæ‹Ÿæœºç¯å¢ƒï¼Œæ— éœ€æ‹…å¿ƒkeyå†²çªå½±å“å…¶ä»–ç³»ç»Ÿèµ„æº
- **æƒé™è®¾ç½®**ï¼š0666ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è¯»å†™ï¼‰ï¼Œç®€åŒ–æƒé™ç®¡ç†

<br>

#### 2. åè°ƒæ¸¸æˆå›åˆ
- è®¾è®¡æ€è·¯ï¼š
    - 1. å›åˆåˆ¶æµç¨‹ï¼šç©å®¶1 â†’ ç©å®¶2 â†’ åˆ¤æ–­èƒœè´Ÿ
    - 2. è¶…æ—¶æœºåˆ¶ï¼šä¸€å®šæ—¶é—´å†…æœªå›å¤è§†ä¸ºå¼ƒæƒ
    - 3. æ¶ˆæ¯æ—¶åºï¼š
        - è£åˆ¤ --type=1--> ç©å®¶1 --type=5--> è£åˆ¤
        - è£åˆ¤ --type=2--> ç©å®¶2 --type=6--> è£åˆ¤
    - 4. çŠ¶æ€ç®¡ç†ï¼š
        - è®°å½•æ¯ä¸ªç©å®¶çš„å‡ºæ‹³é€‰æ‹© (çŸ³å¤´(0) å‰ªåˆ€(1) å¸ƒ(2))
        - å¤„ç†è¶…æ—¶æƒ…å†µï¼ˆchoice = -1ï¼‰
    - 5. èƒœè´Ÿåˆ¤å®šï¼š
        - è¶…æ—¶åˆ¤è´Ÿ
        - æ­£å¸¸å‡ºæ‹³(æ— è¶…æ—¶)æŒ‰ (choice1 + 1) % 3 == choice2 è§„åˆ™
        - æ›´æ–°æ¯”åˆ†ç»Ÿè®¡: 0:å¹³å±€, 1:ç©å®¶1 èƒœ, 2:ç©å®¶2 èƒœ
    - 6. å®æ—¶å›åˆç»“æœï¼šæ¯å›åˆç»“æŸåç«‹å³æ˜¾ç¤ºåŒæ–¹å‡ºæ‹³å’Œèƒœè´Ÿç»“æœ

<br>


## æ ¸å¿ƒä»£ç å®ç°

#### 0. æ•°æ®ç»“æ„å®šä¹‰
```c
// æ¶ˆæ¯ç»“æ„ - IPCé€šä¿¡è½½ä½“
struct msg_packet {
    long msg_type;  // æ¶ˆæ¯ç±»å‹ï¼šç©å®¶ID(1/2)æˆ–ç©å®¶ID|4(5/6)
    int choice;     // å‡ºæ‹³é€‰æ‹©ï¼š0=çŸ³å¤´,1=å‰ªåˆ€,2=å¸ƒ,-1=è¶…æ—¶
    int round;      // å›åˆæ•°
    int player_id;  // å‘é€è€…IDï¼š1=ç©å®¶1, 2=ç©å®¶2
    int timeout_seconds; // è¶…æ—¶æ—¶é—´(ç§’)ï¼šè£åˆ¤å‘ŠçŸ¥é€‰æ‰‹çš„å“åº”æ—¶é™
};

// æ¸¸æˆçŠ¶æ€ - å…¨å±€çŠ¶æ€ç»´æŠ¤
struct game_state {
    int msgid;      // æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦
    int rounds;     // æ€»å›åˆæ•°
    int scores[3];  // èƒœè´Ÿç»Ÿè®¡ï¼š0=å¹³å±€,1=ç©å®¶1èƒœ,2=ç©å®¶2èƒœ
    int timeouts[3];// è¶…æ—¶ç»Ÿè®¡ï¼š[0]æœªç”¨,[1]=ç©å®¶1è¶…æ—¶,[2]=ç©å®¶2è¶…æ—¶
};

// å‡ºæ‹³åç§° - ç”¨æˆ·å‹å¥½æ˜¾ç¤º
const char* choice_name(int choice) {
    switch(choice) {
        case 0: return "çŸ³å¤´";  // çŸ³å¤´èƒœå‰ªåˆ€
        case 1: return "å‰ªåˆ€";  // å‰ªåˆ€èƒœå¸ƒ  
        case 2: return "å¸ƒ";    // å¸ƒèƒœçŸ³å¤´
        case -1: return "è¶…æ—¶"; // è¶…æ—¶åˆ¤è´Ÿ
        default: return "æœªçŸ¥"; // å¼‚å¸¸å¤„ç†
    }
}
```

<br>

#### 1.åˆ›å»ºå’Œç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—
```c
// åˆ›å»ºå’Œç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—
int create_message_queue() {
    // ftok(path, id): file to key: è·¯å¾„å’ŒIDç”Ÿæˆå”¯ä¸€çš„IPC key
    // åœ¨è£åˆ¤å’Œç©å®¶è¿›ç¨‹ä¸­ä½¿ç”¨ç›¸åŒçš„ï¼ˆpath, idï¼‰ï¼Œ ä»¥è·å–ç›¸åŒçš„keyè®¿é—®åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—
    key_t key = ftok("/tmp", 'R');

    // åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§é˜Ÿåˆ—ï¼ˆä¸æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼‰
    int old_msgid;
    if ((old_msgid = msgget(key, 0666)) != -1) {
        msgctl(old_msgid, IPC_RMID, NULL);
    }
    
    // åˆ›å»ºæ–°é˜Ÿåˆ—
    int msgid = msgget(key, 0666 | IPC_CREAT | IPC_EXCL);
    if (msgid == -1) {
        perror("msgget failed");
        exit(1);
    }
    
    return msgid;
}
```

<br>

#### 2. å‘é€æ¶ˆæ¯ç»™ç©å®¶
```c
// å‘é€æ¶ˆæ¯ç»™ç©å®¶
void 
send_to_player(int msgid, int player_id, int round) {
    struct msg_packet message;
    message.msg_type = player_id;  // ç±»å‹ä¸ºç©å®¶ID
    message.round = round;        // å›åˆæ•°
    message.player_id = player_id;
    message.timeout_seconds = TIMEOUT; // è¶…æ—¶æ—¶é—´(ç§’)ï¼šè£åˆ¤å‘ŠçŸ¥å“åº”æ—¶é™
    
    if (msgsnd(msgid, &message, sizeof(message) - sizeof(long), 0) == -1) {
        printf("å‘é€ç»™ç©å®¶%dçš„æ¶ˆæ¯å¤±è´¥: ", player_id);
        perror("msgsnd failed");
        exit(1);  // ç›´æ¥é€€å‡ºç¨‹åº
    }
}
```

<br>


#### 3. æ¥æ”¶ç©å®¶æ¶ˆæ¯ï¼ˆå¸¦è¶…æ—¶ï¼‰
```c
// æ¥æ”¶ç©å®¶æ¶ˆæ¯ï¼ˆå¸¦è¶…æ—¶ï¼‰
int receive_from_player(int msgid, int player_id, int *choice) {
    struct msg_packet message;
    time_t start_time = time(NULL);
    
    while (time(NULL) - start_time < TIMEOUT) {
        // éé˜»å¡æ¥æ”¶
        if (msgrcv(msgid, &message, sizeof(message) - sizeof(long), player_id | 4, IPC_NOWAIT) != -1) {
            *choice = message.choice;
            return 1;  // æˆåŠŸæ¥æ”¶
        }
        
        if (errno != ENOMSG) {
            printf("æ¥å—ç©å®¶%dçš„æ¶ˆæ¯å¤±è´¥: ", player_id);
            perror("msgrcv failed");
            exit(1);  // ç›´æ¥é€€å‡ºç¨‹åº
        }
        
        usleep(100 * 1000);  // ä¼‘çœ 100mså†æ£€æŸ¥
    }
    
    *choice = -1;  // è¶…æ—¶
    return 0;
}
```


#### 4. åˆ¤æ–­èƒœè´Ÿ
```c
// åˆ¤æ–­èƒœè´Ÿ
int judge_winner(int choice1, int choice2) {
    if (choice1 == choice2) return 0;  // å¹³å±€

    if (choice1 == -1) return 2;  // ç©å®¶1è¶…æ—¶ï¼Œç©å®¶2èƒœ
    if (choice2 == -1) return 1;  // ç©å®¶2è¶…æ—¶ï¼Œç©å®¶1èƒœ
    
    // çŸ³å¤´(0)èƒœå‰ªåˆ€(1), å‰ªåˆ€(1)èƒœå¸ƒ(2), å¸ƒ(2)èƒœçŸ³å¤´(0)
    if ((choice1 + 1) % 3 == choice2) return 1;  // ç©å®¶1èƒœ
    return 2;  // ç©å®¶2èƒœ
}
```

<br>

#### 5. è¿è¡Œæ¸¸æˆå›åˆ
```c
// è¿è¡Œæ¸¸æˆå›åˆ
void run_game_round(struct game_state *game, int round) {
    printf("\n=== ç¬¬ %d å›åˆ ===\n", round);
    
    int choice1, choice2;
    
    // é€šçŸ¥ç©å®¶1å‡ºæ‹³
    printf("è£åˆ¤: é€šçŸ¥ç©å®¶1å‡ºæ‹³...\n");
    send_to_player(game->msgid, 1, round);
    
    // ç­‰å¾…ç©å®¶1å›å¤
    if (receive_from_player(game->msgid, 1, &choice1) <= 0) {
        printf("ç©å®¶1è¶…æ—¶ï¼\n");
        game->timeouts[1]++;
    }
    
    // é€šçŸ¥ç©å®¶2å‡ºæ‹³
    printf("è£åˆ¤: é€šçŸ¥ç©å®¶2å‡ºæ‹³...\n");
    send_to_player(game->msgid, 2, round);
    
    // ç­‰å¾…ç©å®¶2å›å¤
    if (receive_from_player(game->msgid, 2, &choice2) <= 0) {
        printf("ç©å®¶2è¶…æ—¶ï¼\n");
        game->timeouts[2]++;
    }
    
    // æ˜¾ç¤ºå‡ºæ‹³ç»“æœ
    printf("ç©å®¶1å‡ºæ‹³: %s\n", choice_name(choice1));
    printf("ç©å®¶2å‡ºæ‹³: %s\n", choice_name(choice2));
    
    // åˆ¤æ–­èƒœè´Ÿ
    int winner = judge_winner(choice1, choice2);
    game->scores[winner]++;
    
    switch(winner) {
        case 0: printf("ç»“æœ: å¹³å±€\n"); break;
        case 1: printf("ç»“æœ: ç©å®¶1è·èƒœ\n"); break;
        case 2: printf("ç»“æœ: ç©å®¶2è·èƒœ\n"); break;
    }
    printf("\n");
}
```

<br>

#### 6. æ˜¾ç¤ºæœ€ç»ˆç»“æœ
```c
// æ˜¾ç¤ºæœ€ç»ˆç»“æœ
void show_final_results(struct game_state *game) {
    printf("\n=== æ¸¸æˆç»“æŸ ===\n");
    printf("æ€»å›åˆæ•°: %d\n", game->rounds);
    printf("å¹³å±€: %d\n", game->scores[0]);
    printf("ç©å®¶1èƒœåˆ©: %d (è¶…æ—¶: %d)\n", game->scores[1], game->timeouts[1]);
    printf("ç©å®¶2èƒœåˆ©: %d (è¶…æ—¶: %d)\n", game->scores[2], game->timeouts[2]);
    
    if (game->scores[1] > game->scores[2]) {
        printf("æœ€ç»ˆèƒœè€…: ç©å®¶1\n");
    } else if (game->scores[2] > game->scores[1]) {
        printf("æœ€ç»ˆèƒœè€…: ç©å®¶2\n");
    } else {
        printf("æœ€ç»ˆç»“æœ: å¹³å±€\n");
    }
}
```

#### 7. ä¸»ç¨‹åºé€»è¾‘ main()
```c

#define MAX_ROUNDS 100
#define TIMEOUT 5  // 5ç§’è¶…æ—¶

int main(int argc, char *argv[]) {
    if (argc != 2) {
        printf("ç”¨æ³•: %s <å›åˆæ•°>\n", argv[0]);
        return 1;
    }
    
    int rounds = atoi(argv[1]);
    if (rounds <= 0 || rounds > MAX_ROUNDS) {
        printf("å›åˆæ•°å¿…é¡»åœ¨1-%dä¹‹é—´\n", MAX_ROUNDS);
        return 1;
    }
    
    printf("åˆ›å»ºçŸ³å¤´å‰ªåˆ€å¸ƒæ¸¸æˆ (%då›åˆ)...\n", rounds);
    
    // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
    struct game_state game;
    memset(&game, 0, sizeof(game));
    game.rounds = rounds;
    game.msgid = create_message_queue();
    
    printf("æ¶ˆæ¯é˜Ÿåˆ—åˆ›å»ºæˆåŠŸ (ID: %d)\n", game.msgid);
    printf("è¯·åœ¨å…¶ä»–ç»ˆç«¯å¯åŠ¨ç©å®¶è¿›ç¨‹: ./player\n");
    printf("ç­‰å¾…ç©å®¶è¿æ¥...\n");
    
    sleep(2);  // ç»™ç©å®¶æ—¶é—´è¿æ¥
    
    // è¿è¡Œæ‰€æœ‰å›åˆ
    for (int i = 1; i <= rounds; i++) {
        run_game_round(&game, i);
        sleep(1);  // å›åˆé—´éš”
    }
    
    // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
    show_final_results(&game);
    
    // æ¸…ç†æ¶ˆæ¯é˜Ÿåˆ—
    msgctl(game.msgid, IPC_RMID, NULL);
    printf("æ¶ˆæ¯é˜Ÿåˆ—å·²æ¸…ç†\n");
    
    return 0;
}
```

#### 8. æ–°åŠ ï¼š ç­‰å¾…ç©å®¶è¿æ¥
```c
#define MSG_TYPE_PUBLIC 0      // å…¬å…±æ¶ˆæ¯ç±»å‹ï¼Œç”¨äºIDåˆ†é…
#define MSG_TYPE_CONNECT 100   // ç©å®¶è¿æ¥ç¡®è®¤æ¶ˆæ¯ç±»å‹

// ç­‰å¾…ç©å®¶è¿æ¥ç¡®è®¤
void wait_for_players_connection(int msgid)
{
    
    // å…ˆåˆ†é…ä¸¤ä¸ªç©å®¶IDï¼ˆç®€å•å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
    struct msg_packet id_message;
    id_message.msg_type = MSG_TYPE_ID_ASSIGN; // è£åˆ¤â†’ç©å®¶ï¼šåˆ†é…ID
    id_message.player_id = 1;                 // ç©å®¶1 ID
    msgsnd(msgid, &id_message, sizeof(id_message) - sizeof(long), 0);
    
    id_message.player_id = 2; // ç©å®¶2 ID
    msgsnd(msgid, &id_message, sizeof(id_message) - sizeof(long), 0);
    
    printf("ç­‰å¾…ç©å®¶è¿æ¥...\n");

    // ä¸‹é¢æ˜¯åŸæœ‰çš„ç­‰å¾…è¿æ¥é€»è¾‘
    int connected_players = 0;
    struct msg_packet message;
    time_t start_time = time(NULL);

    while (connected_players < 2 && (time(NULL) - start_time < 30))
    {
        // éé˜»å¡æ¥æ”¶è¿æ¥ç¡®è®¤æ¶ˆæ¯
        // ç©å®¶â†’è£åˆ¤ï¼šè¿æ¥ç¡®è®¤
        if (msgrcv(msgid, &message, sizeof(message) - sizeof(long), MSG_TYPE_CONNECT_ACK, IPC_NOWAIT) != -1)
        {
            connected_players++;
            printf("ç©å®¶%d è¿æ¥æˆåŠŸ!\n", message.player_id);
        }
        else if (errno != ENOMSG)
        {
            perror("æ¥æ”¶è¿æ¥æ¶ˆæ¯å¤±è´¥");
            break;
        }

        // æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
        if (connected_players == 0)
        {
            printf("ç­‰å¾…ç©å®¶è¿æ¥ä¸­... å·²ç­‰å¾… %ld ç§’\r", time(NULL) - start_time);
            fflush(stdout);
        }

        sleep(1);
    }

    printf("\n");
    if (connected_players == 2)
    {
        printf("âœ… æ‰€æœ‰ç©å®¶è¿æ¥æˆåŠŸï¼å¼€å§‹æ¸¸æˆ...\n");
    }
    else if (connected_players == 1)
    {
        printf("âš ï¸  åªæœ‰1åç©å®¶è¿æ¥ï¼Œç»§ç»­ç­‰å¾…æˆ–å¼€å§‹æ¸¸æˆ...\n");
    }
    else
    {
        printf("âŒ æ²¡æœ‰ç©å®¶è¿æ¥ï¼Œè¯·æ£€æŸ¥ç©å®¶è¿›ç¨‹æ˜¯å¦å¯åŠ¨\n");
        exit(1);
    }
}
```